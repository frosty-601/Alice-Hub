local TweenService = game:GetService("TweenService")
local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
local camera = game.Workspace.CurrentCamera

-- Create UI elements
local topbarPlus = playerGui:WaitForChild("TopbarPlus")
local topbarContainer = topbarPlus:WaitForChild("TopbarContainer")
local unnamedIcon = topbarContainer:WaitForChild("UnnamedIcon")
local dropdownContainer = unnamedIcon:WaitForChild("DropdownContainer")
local dropdownFrame = dropdownContainer:WaitForChild("DropdownFrame")

local charFrame = Instance.new("Frame")
charFrame.Name = "Char"
charFrame.Parent = dropdownFrame
charFrame.BackgroundTransparency = 1
charFrame.BorderColor3 = Color3.fromRGB(27, 42, 53)
charFrame.BorderSizePixel = 1
charFrame.Size = UDim2.new(1, 0, 0, 32)
charFrame.ZIndex = 1

local iconButton = Instance.new("TextButton")
iconButton.Name = "IconButton"
iconButton.Parent = charFrame
iconButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
iconButton.BackgroundTransparency = 0.5
iconButton.BorderSizePixel = 0
iconButton.Text = ""
iconButton.Size = UDim2.new(1, 0, 1, 0)
iconButton.Font = Enum.Font.Legacy
iconButton.LayoutOrder = 0

local iconImage = Instance.new("ImageLabel")
iconImage.Name = "IconImage"
iconImage.Parent = iconButton
iconImage.BackgroundTransparency = 1
iconImage.Image = "rbxassetid://18831496392"
iconImage.ImageColor3 = Color3.fromRGB(255, 255, 255)
iconImage.Position = UDim2.new(0, 12, 0, 15)
iconImage.Size = UDim2.new(0, 24, 0, 24)
iconImage.ZIndex = 11

local iconLabel = Instance.new("TextLabel")
iconLabel.Name = "IconLabel"
iconLabel.Parent = iconButton
iconLabel.BackgroundTransparency = 1
iconLabel.Font = Enum.Font.GothamMedium
iconLabel.Text = "Goku"
iconLabel.TextColor3 = Color3.fromRGB(255, 216, 19)
iconLabel.TextSize = 14
iconLabel.Position = UDim2.new(0, 44, 0, 15)
iconLabel.Size = UDim2.new(1, -56, 0, 7)
iconLabel.ZIndex = 11

-- Create the Tool
local tool = Instance.new("Tool")
tool.Name = "Instant Transmission"
tool.RequiresHandle = false
tool.CanBeDropped = false
tool.Parent = player.Backpack

-- Cutscene and fade effect
local cutsceneDuration = 3
local fadeDuration = 2

local screenGui = Instance.new("ScreenGui", playerGui)
local frame = Instance.new("Frame", screenGui)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.Position = UDim2.new(0.5, 0, 0.5, 0)
frame.Size = UDim2.new(0, 900, 0, 900)
frame.BackgroundColor3 = Color3.new(0, 0, 0)
frame.BackgroundTransparency = 1

local textLabel = Instance.new("TextLabel", screenGui)
textLabel.AnchorPoint = Vector2.new(0.5, 0.5)
textLabel.Position = UDim2.new(0.5, 0, 0.5, 0)
textLabel.Size = UDim2.new(0.2, 0, 0.1, 0)
textLabel.BackgroundTransparency = 1
textLabel.Text = "超级赛亚人" -- "Super Saiyan" in Chinese
textLabel.TextColor3 = Color3.new(1, 0, 0)
textLabel.TextScaled = true
textLabel.Font = Enum.Font.SourceSansBold
textLabel.TextTransparency = 1

local fadeInInfo = TweenInfo.new(
    fadeDuration, -- Time
    Enum.EasingStyle.Sine, -- EasingStyle
    Enum.EasingDirection.InOut -- EasingDirection
)

local fadeOutInfo = TweenInfo.new(
    fadeDuration, -- Time
    Enum.EasingStyle.Sine, -- EasingStyle
    Enum.EasingDirection.InOut -- EasingDirection
)

local tweenInfo = TweenInfo.new(
    cutsceneDuration, -- Time
    Enum.EasingStyle.Sine, -- EasingStyle
    Enum.EasingDirection.InOut -- EasingDirection
)

local initialCFrame = humanoidRootPart.CFrame * CFrame.new(0, -5, 0)
local finalCFrame = humanoidRootPart.CFrame * CFrame.new(0, 2, 2) * CFrame.Angles(0, math.rad(180), 0)

local cameraTween = TweenService:Create(camera, tweenInfo, {CFrame = finalCFrame})
local fadeInTween = TweenService:Create(frame, fadeInInfo, {BackgroundTransparency = 0})
local fadeOutTween = TweenService:Create(frame, fadeOutInfo, {BackgroundTransparency = 1})
local textFadeInTween = TweenService:Create(textLabel, fadeInInfo, {TextTransparency = 0})
local textFadeOutTween = TweenService:Create(textLabel, fadeOutInfo, {TextTransparency = 1})

local function playCutscene()
    camera.CFrame = initialCFrame
    fadeInTween:Play()
    textFadeInTween:Play()
    fadeInTween.Completed:Wait()

    cameraTween:Play()
    cameraTween.Completed:Wait()

    fadeOutTween:Play()
    textFadeOutTween:Play()
    fadeOutTween.Completed:Wait()

    camera.CameraSubject = character:WaitForChild("Humanoid")
end

-- Function to find the closest player
local function findClosestPlayer()
    local character = player.Character
    if not character then return nil end

    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return nil end

    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, otherPlayer in pairs(game.Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local otherHumanoidRootPart = otherPlayer.Character.HumanoidRootPart
            local distance = (humanoidRootPart.Position - otherHumanoidRootPart.Position).magnitude

            if distance < shortestDistance then
                shortestDistance = distance
                closestPlayer = otherPlayer
            end
        end
    end

    return closestPlayer
end

-- Function to teleport the player to the closest player
local function teleportToClosestPlayer()
    local closestPlayer = findClosestPlayer()

    if closestPlayer and closestPlayer.Character then
        local closestHumanoidRootPart = closestPlayer.Character:FindFirstChild("HumanoidRootPart")
        if closestHumanoidRootPart then
            humanoidRootPart.CFrame = closestHumanoidRootPart.CFrame * CFrame.new(0, 0, 3) -- Teleport 3 studs behind the closest player
        end
    end
end

-- Function to execute when the tool is activated
tool.Activated:Connect(function()
    teleportToClosestPlayer()
end)

-- Notification function
local function onErrorNotification()
    game.StarterGui:SetCore("SendNotification", {
        Title = "NOTIFICATION";
        Text = "YOU'RE ALREADY PLAYING AS THIS CHARACTER.";
        Duration = 5;
    })
end

-- Handle button click
local function handleIconButtonClick()
    local scriptHasRun = character:FindFirstChild("ScriptHasRun")
    if scriptHasRun and scriptHasRun.Value then
        onErrorNotification()
        return
    end

    if not scriptHasRun then
        scriptHasRun = Instance.new("BoolValue")
        scriptHasRun.Name = "ScriptHasRun"
        scriptHasRun.Value = true
        scriptHasRun.Parent = character
    else
        scriptHasRun.Value = true
    end

    -- Update hotbar with tool names
    local hotbar = playerGui:FindFirstChild("Hotbar")
    if hotbar then
        local backpack = hotbar:FindFirstChild("Backpack")
        if backpack then
            local hotbarFrame = backpack:FindFirstChild("Hotbar")
            if hotbarFrame then
                for i = 1, 4 do
                    local baseButton = hotbarFrame:FindFirstChild(tostring(i)).Base
                    local toolName = baseButton:FindFirstChild("ToolName")
                    if toolName then
                        toolName.Text = (i == 1 and "Air combo") or
                                        (i == 2 and "Sky suplex") or
                                        (i == 3 and "Launch") or
                                        (i == 4 and "Speed blitz") or ""
                    end
                end
            end
        end
    end

    -- Load animations
    local function playAnimation(animationId, animationAssetId, speed, startTime, duration)
        local animationTrack = humanoid:LoadAnimation
        animationTrack.AnimationId = animationAssetId
        animationTrack:Play()
        animationTrack:AdjustSpeed(speed)
        animationTrack.TimePosition = startTime
        if duration then
            delay(duration, function()
                animationTrack:Stop()
            end)
        end
    end

    local animations = {
        {12273188754, "rbxassetid://17799224866", 0.1, 0},
        {12296113986, "rbxassetid://18182425133", 1, 0},
        {12309835105, "rbxassetid://13376869471", 1, 0, 1.8},
        {13603396939, "rbxassetid://13633468484", 0, 0},
        {11343318134, "rbxassetid://12983333733", 0.5, 2},
        {15955393872, "rbxassetid://15943915877", 1, 0.05},
        {12983333733, "rbxassetid://13073745835", 0.2, 0},
        {12447707844, "rbxassetid://18435303746", 1, 0},
        {10479335397, "rbxassetid://17838006839", 0.7, 0, 1.2},
        {10503381238, "rbxassetid://14900168720", 0.7, 1.3},
        {10470104242, "rbxassetid://12447247483", 6, 0.2},
        {12342141464, "rbxassetid://17292505729", 0.5, 0},
        {15943915877, "rbxassetid://18464351556", 1, 1},
        {18464351556, "rbxassetid://14374357351", 1, 1},
        {12272894215, "rbxassetid://14046756619", 1, 0},
        {16310343179, "rbxassetid://15997042291", 1.7, 0},
    }

    for _, anim in ipairs(animations) do
        humanoid.AnimationPlayed:Connect(function(animationTrack)
            if animationTrack.Animation.AnimationId == "rbxassetid://" .. anim[1] then
                for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
                    track:Stop()
                end
                playAnimation(anim[1], anim[2], anim[3], anim[4], anim[5])
            end
        end)
    end

    -- Play cutscene
    playCutscene()
end

iconButton.MouseButton1Click:Connect(handleIconButtonClick)

-- Reset scriptHasRun when character respawns
player.CharacterAdded:Connect(function(character)
    local scriptHasRun = character:FindFirstChild("ScriptHasRun")
    if scriptHasRun then
        scriptHasRun.Value = false
    end
end)

if player.Character then
    local scriptHasRun = player.Character:FindFirstChild("ScriptHasRun")
    if scriptHasRun then
        scriptHasRun.Value = false
    end
end

-- Find and update GUI elements with "SUPER SAIYAN" text
local function findGuiAndSetText()
    local screenGui = playerGui:FindFirstChild("ScreenGui")
    if screenGui then
        local magicHealthFrame = screenGui:FindFirstChild("MagicHealth")
        if magicHealthFrame then
            local textLabel = magicHealthFrame:FindFirstChild("TextLabel")
            if textLabel then
                textLabel.Text = "SUPER SAIYAN"
            end
        end
    end
end

playerGui.DescendantAdded:Connect(findGuiAndSetText)
findGuiAndSetText()
