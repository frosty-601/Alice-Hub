-- Character Script Setup
local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local topbarPlus = playerGui:WaitForChild("TopbarPlus")
local topbarContainer = topbarPlus:WaitForChild("TopbarContainer")
local unnamedIcon = topbarContainer:WaitForChild("UnnamedIcon")
local dropdownContainer = unnamedIcon:WaitForChild("DropdownContainer")
local dropdownFrame = dropdownContainer:WaitForChild("DropdownFrame")

-- Create GUI elements for character selection
local charFrame = Instance.new("Frame")
charFrame.Name = "Char"
charFrame.Parent = dropdownFrame
charFrame.BackgroundTransparency = 1
charFrame.BorderColor3 = Color3.fromRGB(27, 42, 53)
charFrame.BorderSizePixel = 1
charFrame.LayoutOrder = 14
charFrame.Size = UDim2.new(1, 0, 0, 32)
charFrame.SizeConstraint = Enum.SizeConstraint.RelativeXY
charFrame.ZIndex = 1

local iconButton = Instance.new("TextButton")
iconButton.Name = "IconButton"
iconButton.Parent = charFrame
iconButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
iconButton.BackgroundTransparency = 0.5
iconButton.BorderSizePixel = 0
iconButton.Text = ""
iconButton.TextScaled = false
iconButton.TextSize = 8
iconButton.TextTransparency = 1
iconButton.TextWrapped = false
iconButton.Position = UDim2.new(0, 0, 0, 0)
iconButton.Size = UDim2.new(1, 0, 1, 0)
iconButton.SizeConstraint = Enum.SizeConstraint.RelativeXY
iconButton.Font = Enum.Font.Legacy
iconButton.LayoutOrder = 0

local iconImage = Instance.new("ImageLabel")
iconImage.Name = "IconImage"
iconImage.Parent = iconButton
iconImage.AnchorPoint = Vector2.new(0, 0.5)
iconImage.BackgroundTransparency = 1
iconImage.BorderColor3 = Color3.fromRGB(27, 42, 53)
iconImage.BorderSizePixel = 1
iconImage.Image = "rbxassetid://18831496392"
iconImage.ImageColor3 = Color3.fromRGB(255, 255, 255)
iconImage.ImageRectOffset = Vector2.new(0, 0)
iconImage.ImageRectSize = Vector2.new(0, 0)
iconImage.ImageTransparency = 0
iconImage.LayoutOrder = 0
iconImage.Position = UDim2.new(0, 12, 0, 15)
iconImage.Size = UDim2.new(0, 24, 0, 24)
iconImage.SizeConstraint = Enum.SizeConstraint.RelativeXY
iconImage.TileSize = UDim2.new(1, 0, 1, 0)
iconImage.SliceScale = 1
iconImage.ZIndex = 11

local iconLabel = Instance.new("TextLabel")
iconLabel.Name = "IconLabel"
iconLabel.Parent = iconButton
iconLabel.AnchorPoint = Vector2.new(0, 0.5)
iconLabel.BackgroundTransparency = 1
iconLabel.BorderColor3 = Color3.fromRGB(27, 42, 53)
iconLabel.BorderSizePixel = 1
iconLabel.Font = Enum.Font.GothamMedium
iconLabel.LayoutOrder = 0
iconLabel.Text = "Goku"
iconLabel.TextColor3 = Color3.fromRGB(255, 216, 19)
iconLabel.TextSize = 14
iconLabel.TextScaled = false
iconLabel.TextTransparency = 0
iconLabel.TextWrapped = false
iconLabel.TextXAlignment = Enum.TextXAlignment.Left
iconLabel.TextYAlignment = Enum.TextYAlignment.Center
iconLabel.Position = UDim2.new(0, 44, 0, 15)
iconLabel.Size = UDim2.new(1, -56, 0, 7)
iconLabel.TextStrokeTransparency = 1
iconLabel.ZIndex = 11

-- Handle Character Script Execution
local function onErrorNotification()
    game.StarterGui:SetCore("SendNotification", {
        Title = "NOTIFICATION";
        Text = "YOU'RE ALREADY PLAYING AS THIS CHARACTER.";
        Icon = "";
        Duration = 5;
    })
end

local function handleIconButtonClick()
    local character = player.Character
    if not character then
        return
    end

    local scriptHasRun = character:FindFirstChild("ScriptHasRun")
    if scriptHasRun and scriptHasRun.Value then
        onErrorNotification()
        return
    end

    if not scriptHasRun then
        scriptHasRun = Instance.new("BoolValue")
        scriptHasRun.Name = "ScriptHasRun"
        scriptHasRun.Value = true
        scriptHasRun.Parent = character
    else
        scriptHasRun.Value = true
    end

    -- Update Hotbar Text
    local hotbar = playerGui:FindFirstChild("Hotbar")
    if hotbar then
        local backpack = hotbar:FindFirstChild("Backpack")
        if backpack then
            local hotbarFrame = backpack:FindFirstChild("Hotbar")
            if hotbarFrame then
                for i = 1, 4 do
                    local baseButton = hotbarFrame:FindFirstChild(tostring(i)).Base
                    local ToolName = baseButton:FindFirstChild("ToolName")
                    if ToolName then
                        local toolNames = {
                            "Air combo",
                            "Sky suplex",
                            "Launch",
                            "Speed blitz"
                        }
                        ToolName.Text = toolNames[i]
                    end
                end
            end
        end
    end

    -- Update Magic Health Text
    local function findGuiAndSetText()
        local screenGui = playerGui:FindFirstChild("ScreenGui")
        if screenGui then
            local magicHealthFrame = screenGui:FindFirstChild("MagicHealth")
            if magicHealthFrame then
                local textLabel = magicHealthFrame:FindFirstChild("TextLabel")
                if textLabel then
                    textLabel.Text = "SUPER SAIYAN"
                end
            end
        end
    end

    playerGui.DescendantAdded:Connect(findGuiAndSetText)
    findGuiAndSetText()

    -- Animation Handling
    local humanoid = character:WaitForChild("Humanoid")

    local function onAnimationPlayed(animationTrack)
        local animationIds = {
            [12273188754] = "rbxassetid://17799224866",
            [12296113986] = "rbxassetid://18182425133",
            [12309835105] = "rbxassetid://13376869471",
            [13603396939] = "rbxassetid://13633468484",
            [11343318134] = "rbxassetid://12983333733",
            [15955393872] = "rbxassetid://15943915877",
            [12983333733] = "rbxassetid://13073745835",
            [12447707844] = "rbxassetid://18435303746",
            [10479335397] = "rbxassetid://17838006839",
            [10503381238] = "rbxassetid://14900168720",
            [10470104242] = "rbxassetid://12447247483",
            [12342141464] = "rbxassetid://17292505729",
            [15943915877] = "rbxassetid://18464351556",
            [18464351556] = "rbxassetid://14374357351",
            [12272894215] = "rbxassetid://14046756619",
            [16310343179] = "rbxassetid://15997042291"
        }

        local replacementId = animationIds[animationTrack.Animation.AnimationId]
        if replacementId then
            for _, animTrack in pairs(humanoid:GetPlayingAnimationTracks()) do
                animTrack:Stop()
            end

            local AnimAnim = Instance.new("Animation")
            AnimAnim.AnimationId = replacementId
            local Anim = humanoid:LoadAnimation(AnimAnim)
            Anim:Play()
            Anim:AdjustSpeed(1)
        end
    end

    humanoid.AnimationPlayed:Connect(onAnimationPlayed)
end

iconButton.MouseButton1Click:Connect(handleIconButtonClick)
local TweenService = game:GetService("TweenService")
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
local playerGui = player:WaitForChild("PlayerGui")
local camera = game.Workspace.CurrentCamera

-- Cutscene and fade effect
local cutsceneDuration = 3
local fadeDuration = 2

local screenGui = Instance.new("ScreenGui", playerGui)
local frame = Instance.new("Frame", screenGui)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.Position = UDim2.new(0.5, 0, 0.5, 0)
frame.Size = UDim2.new(0, 900, 0, 900)
frame.BackgroundColor3 = Color3.new(0, 0, 0)
frame.BackgroundTransparency = 1

local textLabel = Instance.new("TextLabel", screenGui)
textLabel.AnchorPoint = Vector2.new(0.5, 0.5)
textLabel.Position = UDim2.new(0.5, 0, 0.5, 0)
textLabel.Size = UDim2.new(0.2, 0, 0.1, 0)
textLabel.BackgroundTransparency = 1
textLabel.Text = "超级赛亚人" -- "Super Saiyan" in Chinese
textLabel.TextColor3 = Color3.new(1, 0, 0)
textLabel.TextScaled = true
textLabel.Font = Enum.Font.SourceSansBold
textLabel.TextTransparency = 1

local fadeInInfo = TweenInfo.new(
    fadeDuration, -- Time
    Enum.EasingStyle.Sine, -- EasingStyle
    Enum.EasingDirection.InOut -- EasingDirection
)

local fadeOutInfo = TweenInfo.new(
    fadeDuration, -- Time
    Enum.EasingStyle.Sine, -- EasingStyle
    Enum.EasingDirection.InOut -- EasingDirection
)

local tweenInfo = TweenInfo.new(
    cutsceneDuration, -- Time
    Enum.EasingStyle.Sine, -- EasingStyle
    Enum.EasingDirection.InOut -- EasingDirection
)

local initialCFrame = humanoidRootPart.CFrame * CFrame.new(0, -5, 0)
local finalCFrame = humanoidRootPart.CFrame * CFrame.new(0, 2, 2) * CFrame.Angles(0, math.rad(180), 0)

local cameraTween = TweenService:Create(camera, tweenInfo, {CFrame = finalCFrame})
local fadeInTween = TweenService:Create(frame, fadeInInfo, {BackgroundTransparency = 0})
local fadeOutTween = TweenService:Create(frame, fadeOutInfo, {BackgroundTransparency = 1})
local textFadeInTween = TweenService:Create(textLabel, fadeInInfo, {TextTransparency = 0})
local textFadeOutTween = TweenService:Create(textLabel, fadeOutInfo, {TextTransparency = 1})

local function playCutscene()
    camera.CFrame = initialCFrame
    fadeInTween:Play()
    textFadeInTween:Play()
    fadeInTween.Completed:Wait()

    cameraTween:Play()
    cameraTween.Completed:Wait()

    fadeOutTween:Play()
    textFadeOutTween:Play()
    fadeOutTween.Completed:Wait()

    camera.CameraSubject = character:WaitForChild("Humanoid")
end

-- Create the Tool
local tool = Instance.new("Tool")
tool.Name = "Instant Transmission"
tool.RequiresHandle = false
tool.CanBeDropped = false
tool.Parent = player.Backpack

-- Function to find the closest player
local function findClosestPlayer()
    local character = player.Character
    if not character then return nil end

    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return nil end

    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, otherPlayer in pairs(game.Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local otherHumanoidRootPart = otherPlayer.Character.HumanoidRootPart
            local distance = (humanoidRootPart.Position - otherHumanoidRootPart.Position).magnitude

            if distance < shortestDistance then
                shortestDistance = distance
                closestPlayer = otherPlayer
            end
        end
    end

    return closestPlayer
end

-- Function to teleport the player to the closest player
local function teleportToClosestPlayer()
    local closestPlayer = findClosestPlayer()

    if closestPlayer and closestPlayer.Character then
        local closestHumanoidRootPart = closestPlayer.Character:FindFirstChild("HumanoidRootPart")
        if closestHumanoidRootPart then
            humanoidRootPart.CFrame = closestHumanoidRootPart.CFrame * CFrame.new(0, 0, 3) -- Teleport 3 studs behind the closest player
        end
    end
end

-- Function to execute when the tool is activated
tool.Activated:Connect(function()
    teleportToClosestPlayer()
end)

-- Function to execute when the character is clicked
local function onCharacterClicked()
    playCutscene()
end

-- Bind the onCharacterClicked function to an event (e.g., ClickDetector)
local clickDetector = character:FindFirstChildOfClass("ClickDetector")
if clickDetector then
    clickDetector.MouseClick:Connect(onCharacterClicked)
end

-- Ensure that scriptHasRun is properly handled
if player.Character then
    local scriptHasRun = player.Character:FindFirstChild("ScriptHasRun")
    if scriptHasRun then
        scriptHasRun.Value = false
    end
end
player.CharacterAdded:Connect(function(character)
    local scriptHasRun = character:FindFirstChild("ScriptHasRun")
    if scriptHasRun then
        scriptHasRun.Value = false
    end
end)

if player.Character then
    local scriptHasRun = player.Character:FindFirstChild("ScriptHasRun")
    if scriptHasRun then
        scriptHasRun.Value = false
    end
end
